# 🧪 Stripe 支付流程測試指南

## 📋 測試前準備

### 1. 確認環境變數
確保 `.env` 文件包含以下配置：
```env
# Stripe 測試金鑰
EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51SAKkJRxUrNPaFRS20Vvfyr9Jq0kWxyrZ5jMWfwHdQkYalTHFS6ECvfD0F2D9igzmd8PKDsXfY55bNxJey7xjLjU00UqlgQXvy
STRIPE_SECRET_KEY=sk_test_YOUR_STRIPE_SECRET_KEY_HERE

# Stripe 價格 ID（需要在 Stripe 儀表板創建後更新）
EXPO_PUBLIC_STRIPE_BASIC_MONTHLY_PRICE_ID=price_xxxxxxxxxxxxx
EXPO_PUBLIC_STRIPE_BASIC_YEARLY_PRICE_ID=price_xxxxxxxxxxxxx
EXPO_PUBLIC_STRIPE_PLUS_MONTHLY_PRICE_ID=price_xxxxxxxxxxxxx
EXPO_PUBLIC_STRIPE_PLUS_YEARLY_PRICE_ID=price_xxxxxxxxxxxxx
```

### 2. 啟動應用
```bash
bun run start
```

---

## 🧪 測試場景

### 場景 1：成功訂閱（基礎會員 - 月付）

**步驟：**
1. 打開應用並登入
2. 導航到「訂閱」頁面（設定 → 訂閱管理）
3. 選擇「月付」標籤
4. 點擊「Basic Monthly」方案的「訂閱」按鈕
5. 在 Stripe 結帳頁面輸入測試卡號：
   - 卡號：`4242 4242 4242 4242`
   - 到期日：`12/34`（任何未來日期）
   - CVC：`123`（任何 3 位數字）
   - 郵遞區號：`12345`（任何 5 位數字）
6. 點擊「訂閱」

**預期結果：**
- ✅ 跳轉到成功頁面（`/subscription/success`）
- ✅ 顯示「Payment Successful!」訊息
- ✅ 列出會員權益
- ✅ 5 秒後自動跳轉到首頁
- ✅ 首頁會員卡顯示「Basic Member」
- ✅ 在 Stripe 儀表板看到付款記錄

---

### 場景 2：取消訂閱流程

**步驟：**
1. 打開應用並登入
2. 導航到「訂閱」頁面
3. 選擇「年付」標籤
4. 點擊「Plus Yearly」方案的「訂閱」按鈕
5. 在 Stripe 結帳頁面點擊「返回」或關閉視窗

**預期結果：**
- ✅ 跳轉到取消頁面（`/subscription/cancel`）
- ✅ 顯示「Payment Cancelled」訊息
- ✅ 顯示訂閱的好處
- ✅ 提供「再試一次」和「返回首頁」按鈕
- ✅ 5 秒後自動跳轉到訂閱頁面
- ✅ 會員狀態保持不變

---

### 場景 3：付款失敗（卡片被拒絕）

**步驟：**
1. 打開應用並登入
2. 導航到「訂閱」頁面
3. 選擇任一方案
4. 在 Stripe 結帳頁面輸入失敗測試卡號：
   - 卡號：`4000 0000 0000 0002`
   - 到期日：`12/34`
   - CVC：`123`
   - 郵遞區號：`12345`
5. 點擊「訂閱」

**預期結果：**
- ✅ Stripe 顯示錯誤訊息「Your card was declined」
- ✅ 不會跳轉到成功頁面
- ✅ 會員狀態保持不變
- ✅ Stripe 儀表板沒有成功的付款記錄

---

### 場景 4：3D Secure 驗證

**步驟：**
1. 打開應用並登入
2. 導航到「訂閱」頁面
3. 選擇任一方案
4. 在 Stripe 結帳頁面輸入 3D Secure 測試卡號：
   - 卡號：`4000 0025 0000 3155`
   - 到期日：`12/34`
   - CVC：`123`
   - 郵遞區號：`12345`
5. 點擊「訂閱」
6. 在 3D Secure 驗證頁面點擊「Complete」

**預期結果：**
- ✅ 顯示 3D Secure 驗證頁面
- ✅ 驗證成功後跳轉到成功頁面
- ✅ 會員狀態正確更新
- ✅ Stripe 儀表板顯示付款成功

---

### 場景 5：已訂閱會員查看訂閱頁面

**步驟：**
1. 使用已訂閱的帳號登入
2. 導航到「訂閱」頁面

**預期結果：**
- ✅ 顯示當前會員狀態卡片
- ✅ 顯示當前方案名稱和價格
- ✅ 顯示續訂日期
- ✅ 當前方案顯示「Current Plan」而非「Subscribe」
- ✅ 其他方案仍可點擊升級
- ✅ 顯示「取消訂閱」按鈕

---

### 場景 6：取消現有訂閱

**步驟：**
1. 使用已訂閱的帳號登入
2. 導航到「訂閱」頁面
3. 點擊「取消訂閱」按鈕
4. 在確認對話框點擊「Cancel Subscription」

**預期結果：**
- ✅ 顯示確認對話框
- ✅ 取消成功後顯示成功訊息
- ✅ 會員狀態更新為「Free」
- ✅ 訂閱頁面不再顯示當前方案卡片
- ✅ Stripe 儀表板顯示訂閱已取消

---

### 場景 7：首頁會員狀態顯示

**步驟：**
1. 以不同會員等級登入（免費試用、免費會員、基礎會員、高級會員）
2. 查看首頁

**預期結果：**
- ✅ 顯示會員狀態卡片
- ✅ 正確顯示會員等級圖標：
  - 免費試用/免費會員：Sparkles 圖標（灰色）
  - 基礎會員：Star 圖標（藍色）
  - 高級會員：Crown 圖標（藍色）
- ✅ 正確顯示剩餘使用次數：
  - 免費試用：「2000 uses remaining」
  - 免費會員：「30 uses remaining」（每日）
  - 基礎會員：「1540 uses remaining」（月配額 + 每日獎勵）
  - 高級會員：「Unlimited uses」
- ✅ 免費會員顯示升級提示

---

## 🔍 檢查清單

### Stripe 儀表板檢查
- [ ] 測試模式已啟用
- [ ] 4 個產品已創建（Basic Monthly/Yearly, Plus Monthly/Yearly）
- [ ] 價格 ID 已複製到 `.env`
- [ ] 付款記錄正確顯示
- [ ] 訂閱狀態正確

### 應用功能檢查
- [ ] 訂閱頁面正確顯示所有方案
- [ ] 月付/年付切換正常
- [ ] 價格和功能列表正確
- [ ] 「MOST POPULAR」和「BEST VALUE」標籤顯示正確
- [ ] 成功頁面自動跳轉
- [ ] 取消頁面自動跳轉
- [ ] 會員狀態卡片正確顯示
- [ ] 升級提示僅對免費會員顯示

### 錯誤處理檢查
- [ ] 未登入用戶點擊訂閱顯示登入提示
- [ ] 付款失敗顯示錯誤訊息
- [ ] 網路錯誤有適當提示
- [ ] 已訂閱用戶不能重複訂閱同一方案

---

## 🐛 常見問題排查

### 問題 1：點擊訂閱沒有反應
**可能原因：**
- 價格 ID 未設置或錯誤
- Stripe 金鑰錯誤
- 網路連接問題

**解決方法：**
1. 檢查瀏覽器控制台錯誤
2. 確認 `.env` 中的價格 ID 正確
3. 確認 Stripe 金鑰有效
4. 檢查網路連接

### 問題 2：付款成功但會員狀態未更新
**可能原因：**
- Webhook 未設置
- Webhook 簽名驗證失敗
- 資料庫更新失敗

**解決方法：**
1. 檢查 Stripe 儀表板 Webhook 日誌
2. 確認 Webhook URL 正確
3. 檢查後端日誌
4. 手動觸發 Webhook 測試

### 問題 3：成功頁面不跳轉
**可能原因：**
- 路由配置錯誤
- JavaScript 錯誤

**解決方法：**
1. 檢查瀏覽器控制台錯誤
2. 確認路由文件存在
3. 檢查 `useRouter` 是否正確使用

---

## 📊 測試報告模板

```markdown
## Stripe 支付測試報告

**測試日期：** YYYY-MM-DD
**測試人員：** [姓名]
**測試環境：** [開發/測試/生產]

### 測試結果摘要
- 總測試場景：7
- 通過：X
- 失敗：X
- 阻塞：X

### 詳細結果

#### 場景 1：成功訂閱
- [ ] 通過
- [ ] 失敗
- 備註：

#### 場景 2：取消訂閱流程
- [ ] 通過
- [ ] 失敗
- 備註：

#### 場景 3：付款失敗
- [ ] 通過
- [ ] 失敗
- 備註：

#### 場景 4：3D Secure 驗證
- [ ] 通過
- [ ] 失敗
- 備註：

#### 場景 5：已訂閱會員查看
- [ ] 通過
- [ ] 失敗
- 備註：

#### 場景 6：取消現有訂閱
- [ ] 通過
- [ ] 失敗
- 備註：

#### 場景 7：首頁會員狀態
- [ ] 通過
- [ ] 失敗
- 備註：

### 發現的問題
1. [問題描述]
   - 嚴重程度：[高/中/低]
   - 重現步驟：
   - 預期結果：
   - 實際結果：

### 建議
[測試建議和改進意見]
```

---

## ✅ 測試完成後

1. **記錄測試結果**：填寫測試報告
2. **截圖保存**：保存關鍵步驟的截圖
3. **更新文檔**：如發現文檔錯誤，及時更新
4. **報告問題**：將發現的問題提交到問題追蹤系統
5. **驗證修復**：問題修復後重新測試

---

## 📞 支援

如果測試過程中遇到問題：
1. 查看 [Stripe 文檔](https://stripe.com/docs)
2. 檢查應用日誌
3. 查看 Stripe 儀表板日誌
4. 聯繫技術支援
