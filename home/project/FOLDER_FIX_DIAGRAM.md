# 資料夾數字修正 - 視覺化流程圖

## 🔴 問題流程 (Before Fix)

```
使用者點擊「新增資料夾」
         ↓
輸入資料夾名稱: "喵喵"
         ↓
建立資料夾物件
{
  id: "123",
  name: "喵喵",
  count: undefined  ← 問題！未初始化
}
         ↓
儲存到 AsyncStorage
         ↓
讀取並顯示
         ↓
count 為 undefined
         ↓
轉換為字串時出錯
         ↓
❌ 顯示亂碼: "ö"
```

## 🟢 修正流程 (After Fix)

```
使用者點擊「新增資料夾」
         ↓
輸入資料夾名稱: "喵喵"
         ↓
FolderProvider.addFolder("喵喵")
         ↓
建立資料夾物件
{
  id: "1704326400000",
  name: "喵喵",
  count: 0,  ← ✅ 明確初始化為 0
  createdAt: "2025-01-04T00:00:00.000Z",
  updatedAt: "2025-01-04T00:00:00.000Z"
}
         ↓
型別驗證
typeof count === 'number' ✅
!isNaN(count) ✅
         ↓
儲存到 AsyncStorage
JSON.stringify(folders)
         ↓
讀取時驗證
validatedFolders = folders.map(f => ({
  ...f,
  count: typeof f.count === 'number' ? f.count : 0
}))
         ↓
顯示在 UI
         ↓
✅ 正確顯示: "0"
```

## 📊 資料流程圖

```
┌─────────────────────────────────────────────────────────┐
│                    FolderProvider                        │
│  ┌────────────────────────────────────────────────┐    │
│  │  State: folders: Folder[]                      │    │
│  │         isLoading: boolean                     │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  Methods:                                      │    │
│  │  • addFolder(name)                             │    │
│  │  • deleteFolder(id)                            │    │
│  │  • updateFolderCount(id, count)                │    │
│  │  • getFolderById(id)                           │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  Validation:                                   │    │
│  │  • On Load: Fix invalid counts                 │    │
│  │  • On Create: Initialize count = 0             │    │
│  │  • On Update: Validate number type             │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                         ↓
                         ↓
┌─────────────────────────────────────────────────────────┐
│                    AsyncStorage                          │
│  Key: "@folders"                                         │
│  Value: JSON string                                      │
│  [                                                       │
│    {                                                     │
│      "id": "1704326400000",                              │
│      "name": "喵喵",                                      │
│      "count": 0,  ← Always a number                     │
│      "createdAt": "2025-01-04T00:00:00.000Z",           │
│      "updatedAt": "2025-01-04T00:00:00.000Z"            │
│    }                                                     │
│  ]                                                       │
└─────────────────────────────────────────────────────────┘
                         ↓
                         ↓
┌─────────────────────────────────────────────────────────┐
│                    FolderList Component                  │
│  ┌────────────────────────────────────────────────┐    │
│  │  Display:                                      │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │  📁 喵喵                              │     │    │
│  │  │     0 bookmarks  ← ✅ Correct!       │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  │                                                │    │
│  │  ┌──────────────────────────────────────┐     │    │
│  │  │  📁 뉴스                              │     │    │
│  │  │     0 bookmarks  ← ✅ Correct!       │     │    │
│  │  └──────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## 🔄 驗證循環

```
┌──────────────────────────────────────────────────┐
│  1. 載入資料 (Load Data)                          │
│     AsyncStorage.getItem('@folders')             │
└──────────────────┬───────────────────────────────┘
                   ↓
┌──────────────────────────────────────────────────┐
│  2. 解析 JSON (Parse JSON)                        │
│     JSON.parse(stored)                           │
└──────────────────┬───────────────────────────────┘
                   ↓
┌──────────────────────────────────────────────────┐
│  3. 驗證每個資料夾 (Validate Each Folder)         │
│     folders.map(folder => {                      │
│       count: typeof folder.count === 'number'    │
│              ? folder.count                      │
│              : 0                                 │
│     })                                           │
└──────────────────┬───────────────────────────────┘
                   ↓
┌──────────────────────────────────────────────────┐
│  4. 更新狀態 (Update State)                       │
│     setFolders(validatedFolders)                 │
└──────────────────┬───────────────────────────────┘
                   ↓
┌──────────────────────────────────────────────────┐
│  5. 渲染 UI (Render UI)                           │
│     {folder.count} bookmarks                     │
└──────────────────────────────────────────────────┘
```

## 🛠️ 修復工具流程

```
執行修復腳本
npx ts-node scripts/fix-folder-counts.ts
         ↓
┌─────────────────────────────────────────┐
│  1. 驗證資料 (Validate Data)             │
│     validateFolderData()                │
│     • 檢查 ID                            │
│     • 檢查名稱                           │
│     • 檢查 count 型別                    │
│     • 檢查 count 範圍                    │
└─────────────┬───────────────────────────┘
              ↓
         有問題？
         /    \
       是      否
       ↓       ↓
┌──────────┐  ┌──────────┐
│ 修復資料  │  │ 完成     │
│ Fix Data │  │ Done     │
└─────┬────┘  └──────────┘
      ↓
┌─────────────────────────────────────────┐
│  2. 修正 count (Fix Counts)              │
│     fixFolderCounts()                   │
│     • 數字 → 保持                        │
│     • 字串 → parseInt                    │
│     • null/undefined → 0                │
│     • NaN → 0                           │
└─────────────┬───────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  3. 儲存修正後的資料                      │
│     AsyncStorage.setItem()              │
└─────────────┬───────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  4. 重新驗證 (Re-validate)               │
│     validateFolderData()                │
└─────────────┬───────────────────────────┘
              ↓
         全部正確？
         /    \
       是      否
       ↓       ↓
    ✅ 成功   ⚠️ 警告
```

## 🎯 型別轉換邏輯

```
輸入 count 值
      ↓
┌─────────────────────────────────────────┐
│  typeof count === 'number'?             │
└─────┬───────────────────────┬───────────┘
     是                       否
      ↓                        ↓
┌──────────┐         ┌──────────────────┐
│ !isNaN?  │         │ typeof === 'string'? │
└────┬─────┘         └────┬─────────────┘
    是│否                是│否
     ↓ ↓                  ↓ ↓
    ✅ 0            ┌──────────┐ 0
    保持            │ parseInt │
                    └────┬─────┘
                        是│否
                         ↓ ↓
                        ✅ 0
                        使用
```

## 📱 UI 顯示流程

```
FolderList Component
         ↓
┌─────────────────────────────────────────┐
│  const { folders } = useFolders()       │
└─────────────┬───────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  folders.map(folder => ...)             │
└─────────────┬───────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  <View>                                 │
│    <FolderIcon />                       │
│    <Text>{folder.name}</Text>           │
│    <Text>                               │
│      {folder.count} {t('bookmarks')}    │
│    </Text>                              │
│  </View>                                │
└─────────────────────────────────────────┘
              ↓
         渲染結果
┌─────────────────────────────────────────┐
│  📁 喵喵                                 │
│     0 bookmarks                         │
│                                         │
│  📁 뉴스                                 │
│     0 bookmarks                         │
└─────────────────────────────────────────┘
```

## 🔐 安全檢查層級

```
Level 1: TypeScript 型別系統
         ↓
    count: number  ← 編譯時檢查
         ↓
Level 2: 建立時驗證
         ↓
    count: 0  ← 明確初始化
         ↓
Level 3: 載入時驗證
         ↓
    typeof count === 'number' ? count : 0
         ↓
Level 4: 更新時驗證
         ↓
    const validCount = 
      typeof count === 'number' && !isNaN(count)
        ? count
        : 0
         ↓
Level 5: 顯示時檢查
         ↓
    {folder.count || 0}
         ↓
    ✅ 多層保護，確保正確
```

## 📊 效能優化

```
┌─────────────────────────────────────────┐
│  FolderProvider                         │
│  ┌───────────────────────────────────┐  │
│  │  useMemo                          │  │
│  │  • 快取 context value             │  │
│  │  • 避免不必要的重新渲染            │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  useCallback                      │  │
│  │  • addFolder                      │  │
│  │  • deleteFolder                   │  │
│  │  • updateFolderCount              │  │
│  │  • getFolderById                  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## 🌐 多語系支援

```
Translation Files
         ↓
┌──────────────────────────────────────┐
│  en.json                             │
│  {                                   │
│    "folders": "Folders",             │
│    "bookmarks": "bookmarks"          │
│  }                                   │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│  ko.json                             │
│  {                                   │
│    "folders": "폴더",                 │
│    "bookmarks": "북마크"              │
│  }                                   │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│  zh-TW.json                          │
│  {                                   │
│    "folders": "資料夾",               │
│    "bookmarks": "書籤"                │
│  }                                   │
└──────────────────────────────────────┘
         ↓
    useTranslation()
         ↓
    t('bookmarks')
         ↓
    根據當前語言顯示
```

## 🎨 元件架構

```
App
 └─ FolderProvider  ← 狀態管理
     └─ FolderList  ← UI 元件
         ├─ Header
         │   ├─ Title: "Folders"
         │   └─ Add Button (+)
         ├─ Stats
         │   ├─ Total Folders: 2
         │   └─ Total Bookmarks: 0
         └─ Folder Items
             ├─ Folder 1
             │   ├─ Icon (📁)
             │   ├─ Name: "喵喵"
             │   └─ Count: "0 bookmarks"
             └─ Folder 2
                 ├─ Icon (📁)
                 ├─ Name: "뉴스"
                 └─ Count: "0 bookmarks"
```

## 🔄 完整生命週期

```
1. App 啟動
   └─ FolderProvider 初始化
      └─ loadFolders()
         └─ AsyncStorage.getItem('@folders')
            └─ 驗證並載入資料

2. 使用者操作
   ├─ 新增資料夾
   │  └─ addFolder(name)
   │     └─ 建立 count: 0
   │        └─ 儲存到 AsyncStorage
   │           └─ 更新 UI
   │
   ├─ 刪除資料夾
   │  └─ deleteFolder(id)
   │     └─ 從陣列移除
   │        └─ 儲存到 AsyncStorage
   │           └─ 更新 UI
   │
   └─ 更新數量
      └─ updateFolderCount(id, count)
         └─ 驗證 count
            └─ 更新資料夾
               └─ 儲存到 AsyncStorage
                  └─ 更新 UI

3. App 關閉
   └─ 資料已持久化在 AsyncStorage
```

## ✅ 驗收標準

```
測試項目                     預期結果
─────────────────────────────────────────
新增資料夾                   ✅ 顯示 "0"
資料型別                     ✅ number
多語系切換                   ✅ 正確顯示
Unicode 名稱                 ✅ 支援
重新載入                     ✅ 資料保留
修復腳本                     ✅ 修正亂碼
效能                         ✅ 流暢
錯誤處理                     ✅ 友善提示
```

---

**圖表說明：**
- 🔴 紅色：問題流程
- 🟢 綠色：修正流程
- ✅ 綠勾：正確狀態
- ❌ 紅叉：錯誤狀態
- ⚠️ 警告：需要注意
- 📁 資料夾圖示
- 🔄 循環流程
- ↓ 流程方向
